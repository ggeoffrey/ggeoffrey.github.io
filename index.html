<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <title>GravityGraph</title>
    <link rel="stylesheet" href="main.css"/>
</head>
<body>



    <canvas id="dev-canvas" width="1300" height="600">
        Sadly, your browser doesn't support this technology. <br/>
        Please update your browser or your drivers.
    </canvas>

    <div id="toolbar">
        <button onclick="gravityGraph.resetFocus()">
            Reset
        </button>
        <button onclick="gravityGraph.focusOnRelations()">
            Show relations
        </button>
        <button onclick="gravityGraph.focusOnGroupRelations(GravityGraph.ERelation.INNER_OUTER)">
            Show group relations
        </button>
        <button onclick="gravityGraph.focusOnGroupRelations(GravityGraph.ERelation.INNER)">
            Show group internal relations
        </button>
        <button onclick="gravityGraph.focusOnGroupRelations(GravityGraph.ERelation.OUTER)">
            Show group external relations
        </button>
        Charge : <input id="charge" type="range" min="-150" max="10" step="1" onchange="changeCharge(this.value);"/>
         <span id="chargeVal"></span>
        
         Distance : <input id="distance" type="range" min="-10" max="200" step="1" onchange="changeDistance(this.value);"/>
         <span id="distanceVal"></span>
         
        <button onclick="separate = !separate; gravityGraph.separateGroups(separate);">
            Separate groups
        </button>
        <button onclick="gravityGraph.shake();">
            Shake
        </button>
    </div>

    <div id="tooltip"></div>

    <script src="vendors/three.js"></script>
    <script src="vendors/Detector.js"></script>
    <script src="vendors/OrbitControls.js"></script>
    <script src="vendors/CanvasRenderer.js"></script>
    <script src="vendors/Projector.js"></script>
        
    <script src="vendors/d3.js"></script>
    <script src="vendors/d3.layout.force3D.js"></script>
        
    <script src="vendors/stats.min.js"></script>
    <script src="vendors/tweenjs-0.6.0.min.js"></script>
        
    <script src="vendors/droid_sans_regular.typeface.js"></script>
    
    
    
    <script src="dist/GravityGraph.js"></script>
    
    <!-- external -->
    
    <script src="vendors/underscore-min.js"></script>
    
    


    <script>
        
        /// <reference path="dist/GravityGraph.js" />        
        
        var gravityGraph = new GravityGraph.Graph({
            target : 'dev-canvas',
            //opacity: 0,
            //backgroundColor : 0xffffff,
            quality : "high",
            shadows : false,
            flat : true,
            flow : false,
            stats : true,
            charge : -100,
            distance : 60,
            colorType : "20"  // 10, 20a, 20b, 20c
        });
        
        
        var tooltip = document.getElementById('tooltip');
        gravityGraph.on('nodeOvered', function (event, data) {
            tooltip.style.left = (event.clientX + 20) + "px";
            tooltip.style.top = (event.clientY - 20) + "px";
            
            tooltip.innerText = data.name;
            tooltip.style.opacity = "1";
        });
        
        gravityGraph.on('nodeBlur', function (event) {
            tooltip.style.opacity = "0";
        });
        
        gravityGraph.on('nodeSelected', function (event, data) {
            document.title = data.name;
        });
        
        
        
        d3.json("data-test/miserables.json", function(error, graph) {
            if (error) {
                console.error(error);
            }
            else {
                gravityGraph.setNodes(graph.nodes);
                gravityGraph.setLinks(graph.links);
                               
                gravityGraph.start();
                
                
                /*
                setTimeout(function () {
                    gravityGraph.setNodes(graph.nodes.slice(0,15));
                    gravityGraph.setLinks(graph.links);
                    gravityGraph.start();
                }, 500);
                */
                
                
            }
        });
        
        
        
        
        var separate = false;
        
        
        function changeCharge(val) {
            gravityGraph.setCharge(val);
            
            document.getElementById('charge').value = val;
            document.getElementById('chargeVal').innerText = val;
                        
        }
        
        function changeDistance(val) {
            gravityGraph.setDistance(val);
            
            document.getElementById('distance').value = val;
            document.getElementById('distanceVal').innerText = val;
                        
        }
        
        
        
        
        
        function testLogs(){
            
            
            console.log("loading");
            d3.json("data-test/audit_activity.log.json", function(error, graph) {
                
                
                if (error) {
                    console.error(error);
                }
                else {
                    
                    console.log("formating data");
                    
                    var group = _.groupBy(graph.result, function (item) {
                        return item["action name"];
                    });
                    
                    
                    
                    for(var k in group){
                        group[k] = _.groupBy(group[k], function (item) {
                            return item["action"];
                        });
                        
                        for(var subkey in group[k]){
                            group[k][subkey] = group[k][subkey].length;
                        }
                        
                    }
                    
                    var nodes = {};
                    var links = [];
                    
                    for(var i in group){
                        nodes[i] = {
                            group : "Application",
                            name : i
                        };
                        
                        for(var j in group[i]){
                             nodes[j] = {
                               group: "Action",
                               name : j 
                            };
                            
                            links.push({
                                source : i,
                                target : j,
                                value : group[i][j]
                            });
                            
                        }                        
                    }
                    
                    gravityGraph.setNodes(nodes);
                    gravityGraph.setLinks(links);
                    
                    
                    console.log("Done");
                    
                    gravityGraph.start();                   
                    
                    
                    
                }
            });
            
            
            
            
            
        }
        
        //testLogs();
        
        
        
        
    </script>
</body>
</html>